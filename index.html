<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Brains College Social</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f2f2f2; margin: 0; padding: 0; }
    .container { max-width: 600px; margin: auto; padding: 20px; }
    .card { background: white; padding: 20px; margin-bottom: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .input { width: 100%; padding: 10px; margin: 5px 0; border-radius: 5px; border: 1px solid #ccc; }
    button { padding: 10px 15px; border: none; background: #007bff; color: white; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0056b3; }
    .post { border-bottom: 1px solid #ddd; padding: 10px 0; }
    .profile-pic { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Auth -->
    <div id="auth-card" class="card">
      <h2>Login / Signup</h2>
      <input id="email" type="email" class="input" placeholder="Email">
      <input id="password" type="password" class="input" placeholder="Password">
      <button onclick="signup()">Sign Up</button>
      <button onclick="login()">Log In</button>
      <p id="auth-error" style="color:red;"></p>
    </div>

    <!-- Profile -->
    <div id="profile-card" class="card" style="display:none;">
      <h2>My Profile</h2>
      <img id="profile-pic" class="profile-pic" src="https://via.placeholder.com/50">
      <input id="username" class="input" placeholder="Username">
      <input id="bio" class="input" placeholder="Bio">
      <input type="file" id="pic-upload">
      <button onclick="updateProfile()">Update Profile</button>
      <button onclick="logout()">Logout</button>
    </div>

    <!-- Create Post -->
    <div id="post-card" class="card" style="display:none;">
      <h2>Create Post</h2>
      <textarea id="post-text" class="input" placeholder="What's on your mind?"></textarea>
      <input type="file" id="post-image">
      <button onclick="createPost()">Post</button>
    </div>

    <!-- Feed -->
    <div id="feed-card" class="card" style="display:none;">
      <h2>Feed</h2>
      <div id="feed"></div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile as fbUpdateProfile } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    // Config
    const firebaseConfig = {
      apiKey: "AIzaSyATnEao5q5U-kKcpXETQmz_st2UcDCACPA",
      authDomain: "brains-college-3cfab.firebaseapp.com",
      projectId: "brains-college-3cfab",
      storageBucket: "brains-college-3cfab.appspot.com",
      messagingSenderId: "251169111291",
      appId: "1:251169111291:web:f8175d4b01c68102b4445e"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Auth functions
    async function signup() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      try {
        const userCred = await createUserWithEmailAndPassword(auth, email, password);
        await setDoc(doc(db, "users", userCred.user.uid), {
          email,
          username: "",
          bio: "",
          profilePic: "https://via.placeholder.com/50"
        });
      } catch (e) {
        document.getElementById("auth-error").innerText = e.message;
      }
    }

    async function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        document.getElementById("auth-error").innerText = e.message;
      }
    }

    async function logout() { await signOut(auth); }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        document.getElementById("auth-card").style.display = "none";
        document.getElementById("profile-card").style.display = "block";
        document.getElementById("post-card").style.display = "block";
        document.getElementById("feed-card").style.display = "block";

        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (userDoc.exists()) {
          document.getElementById("username").value = userDoc.data().username;
          document.getElementById("bio").value = userDoc.data().bio;
          document.getElementById("profile-pic").src = userDoc.data().profilePic;
        }
        loadFeed();
      } else {
        document.getElementById("auth-card").style.display = "block";
        document.getElementById("profile-card").style.display = "none";
        document.getElementById("post-card").style.display = "none";
        document.getElementById("feed-card").style.display = "none";
      }
    });

    // Profile update
    async function updateProfile() {
      const user = auth.currentUser;
      const username = document.getElementById("username").value;
      const bio = document.getElementById("bio").value;
      let profilePic = document.getElementById("profile-pic").src;

      const file = document.getElementById("pic-upload").files[0];
      if (file) {
        const picRef = ref(storage, "profilePics/" + user.uid);
        await uploadBytes(picRef, file);
        profilePic = await getDownloadURL(picRef);
      }

      await updateDoc(doc(db, "users", user.uid), { username, bio, profilePic });
      document.getElementById("profile-pic").src = profilePic;
    }

    // Create post
    async function createPost() {
      const user = auth.currentUser;
      const text = document.getElementById("post-text").value;
      let imageUrl = "";

      const file = document.getElementById("post-image").files[0];
      if (file) {
        const postRef = ref(storage, "posts/" + Date.now() + "-" + file.name);
        await uploadBytes(postRef, file);
        imageUrl = await getDownloadURL(postRef);
      }

      await addDoc(collection(db, "posts"), {
        userId: user.uid,
        text,
        imageUrl,
        createdAt: new Date()
      });
      document.getElementById("post-text").value = "";
      document.getElementById("post-image").value = "";
    }

    // Load feed
    function loadFeed() {
      const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
      onSnapshot(q, async (snapshot) => {
        const feedDiv = document.getElementById("feed");
        feedDiv.innerHTML = "";
        for (let docSnap of snapshot.docs) {
          const post = docSnap.data();
          const userDoc = await getDoc(doc(db, "users", post.userId));
          const userData = userDoc.exists() ? userDoc.data() : { username: "Unknown", profilePic: "" };
          feedDiv.innerHTML += `
            <div class="post">
              <img src="${userData.profilePic}" class="profile-pic"> <b>${userData.username}</b>
              <p>${post.text}</p>
              ${post.imageUrl ? `<img src="${post.imageUrl}" style="max-width:100%;">` : ""}
            </div>
          `;
        }
      });
    }

    window.signup = signup;
    window.login = login;
    window.logout = logout;
    window.updateProfile = updateProfile;
    window.createPost = createPost;
  </script>
</body>
  </html>
