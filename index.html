<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Brains College Chat — Debug Build</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:linear-gradient(135deg,#1e3c72,#2a5298);margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;color:#fff}
    .card{width:94%;max-width:420px;background:rgba(255,255,255,0.08);padding:18px;border-radius:12px;backdrop-filter:blur(6px);box-shadow:0 8px 30px rgba(0,0,0,.25)}
    h1{margin:0 0 12px;font-size:20px;text-align:center}
    input{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.06);color:#fff}
    button{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:none;background:#ffcc00;color:#000;font-weight:700;cursor:pointer}
    .small{display:flex;gap:8px}
    .small button{flex:1}
    #errorBox{display:none;background:rgba(255,0,0,0.18);color:#fff;padding:8px;border-radius:6px;margin-bottom:8px;font-size:14px}
    #log{display:block;background:rgba(0,0,0,0.2);padding:8px;border-radius:6px;margin-top:10px;height:90px;overflow:auto;font-size:13px}
    .hidden{display:none}
    .chat-area{margin-top:12px;background:#fff;color:#000;border-radius:8px;padding:10px;max-height:220px;overflow:auto}
    .msg{padding:6px;margin-bottom:6px;border-radius:6px;background:#f1f1f1}
  </style>
</head>
<body>
  <div class="card">
    <h1>Brains College — Chat (Debug)</h1>

    <div id="errorBox"></div>

    <label><strong>Email</strong></label>
    <input id="email" type="email" placeholder="you@example.com" autocomplete="username">

    <label><strong>Password</strong></label>
    <input id="password" type="password" placeholder="min 6 chars" autocomplete="current-password">

    <div class="small">
      <button id="signupBtn" type="button">Sign up</button>
      <button id="loginBtn" type="button">Log in</button>
    </div>

    <div id="authStatus" style="margin-top:6px;font-size:13px;color:#dce775"></div>

    <div id="chatUI" class="hidden">
      <div class="chat-area" id="chatBox"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="messageInput" placeholder="Type message..." />
        <button id="sendBtn" type="button">Send</button>
      </div>
    </div>

    <div id="log" aria-live="polite"></div>
  </div>

  <!-- Firebase compat SDKs (global firebase namespace) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <script>
    // ===== CONFIG - use your project's exact config =====
    const firebaseConfig = {
      apiKey: "AIzaSyATnEao5q5U-kKcpXETQmz_st2UcDCACPA",
      authDomain: "brains-college-3cfab.firebaseapp.com",
      databaseURL: "https://brains-college-3cfab-default-rtdb.firebaseio.com",
      projectId: "brains-college-3cfab",
      storageBucket: "brains-college-3cfab.appspot.com",
      messagingSenderId: "251169111291",
      appId: "1:251169111291:web:f8175d4b01c68102b4445e"
    };

    // ===== helper UI functions =====
    const logEl = id => document.getElementById(id);
    const appendLog = txt => {
      const el = logEl('log');
      el.innerHTML += (new Date()).toLocaleTimeString() + " — " + txt + "<br>";
      el.scrollTop = el.scrollHeight;
    };
    const showError = txt => {
      const e = logEl('errorBox');
      e.style.display = txt ? 'block' : 'none';
      e.textContent = txt || '';
      appendLog("ERROR: " + (txt||''));
    };
    const setAuthStatus = txt => { logEl('authStatus').textContent = txt; appendLog(txt); };

    document.addEventListener('DOMContentLoaded', () => {
      try {
        firebase.initializeApp(firebaseConfig);
      } catch (err) {
        showError("Firebase init failed: " + err.message);
        return;
      }
      const auth = firebase.auth();
      const db = firebase.database();

      const emailInput = logEl('email');
      const passInput = logEl('password');
      const signupBtn = logEl('signupBtn');
      const loginBtn = logEl('loginBtn');
      const chatUI = logEl('chatUI');
      const chatBox = logEl('chatBox');
      const sendBtn = logEl('sendBtn');
      const msgInput = logEl('messageInput');

      appendLog("Firebase initialized.");

      // Event listeners (with visible debug)
      signupBtn.addEventListener('click', () => {
        const email = emailInput.value.trim();
        const pw = passInput.value;
        appendLog("SignUp clicked (email=" + email + ")");
        showError(''); // clear error
        if (!email || !pw) return showError("Enter email and password (pw 6+ chars).");
        auth.createUserWithEmailAndPassword(email, pw)
          .then(userCred => {
            setAuthStatus("Signed up as " + (userCred.user.email||''));
          })
          .catch(err => {
            showError(err.code + " — " + err.message);
            console.error("Signup error:", err);
          });
      });

      loginBtn.addEventListener('click', () => {
        const email = emailInput.value.trim();
        const pw = passInput.value;
        appendLog("Login clicked (email=" + email + ")");
        showError('');
        if (!email || !pw) return showError("Enter email and password.");
        auth.signInWithEmailAndPassword(email, pw)
          .then(userCred => {
            setAuthStatus("Logged in as " + (userCred.user.email||''));
            chatUI.classList.remove('hidden');
            // start listening messages after login
            startListening();
          })
          .catch(err => {
            showError(err.code + " — " + err.message);
            console.error("Login error:", err);
          });
      });

      // auth state
      auth.onAuthStateChanged(user => {
        if (user) {
          setAuthStatus("Auth state: signed in as " + user.email);
          chatUI.classList.remove('hidden');
          startListening();
        } else {
          setAuthStatus("Auth state: signed out");
          chatUI.classList.add('hidden');
          chatBox.innerHTML = "";
        }
      });

      // Send message
      sendBtn.addEventListener('click', () => {
        const text = msgInput.value.trim();
        if (!text) return;
        const user = auth.currentUser;
        if (!user) return showError("You must be logged in to send messages.");
        appendLog("Sending message: " + text);
        db.ref('messages').push({
          userEmail: user.email,
          text,
          t: Date.now()
        }).then(() => {
          msgInput.value = '';
        }).catch(err => {
          showError("DB write failed: " + err.code + " — " + err.message);
          console.error("DB write failed", err);
        });
      });

      let listening = false;
      function startListening(){
        if (listening) return;
        listening = true;
        const messagesRef = db.ref('messages').limitToLast(200);
        messagesRef.on('child_added', snap => {
          const m = snap.val();
          const div = document.createElement('div');
          div.className = 'msg';
          div.textContent = (m.userEmail ? m.userEmail + ': ' : '') + m.text;
          chatBox.appendChild(div);
          chatBox.scrollTop = chatBox.scrollHeight;
        }, err => {
          showError("DB read failed: " + err.code + " — " + err.message);
        });
        appendLog("Listening for messages...");
      }

      // quick test hook: show sdk presence
      if (!firebase || !firebase.auth) {
        showError("Firebase SDK not loaded correctly.");
      } else {
        appendLog("Firebase Auth and Database available.");
      }
    }); // DOMContentLoaded
  </script>
</body>
  </html>
